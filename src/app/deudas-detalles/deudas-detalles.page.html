<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>Detalles de Deuda</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Skeleton mientras carga -->
  <div *ngIf="cargando" class="skeleton-container">
    <ion-card>
      <ion-card-header>
        <ion-skeleton-text animated style="width: 60%; height: 24px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 50%; height: 20px; margin-top: 8px;"></ion-skeleton-text>
      </ion-card-header>
      <ion-card-content>
        <ion-skeleton-text animated style="width: 40%; height: 18px;"></ion-skeleton-text>
      </ion-card-content>
    </ion-card>
    <div style="padding: 12px;">
      <ion-card *ngFor="let i of [1,2,3]">
        <ion-card-content>
          <ion-skeleton-text animated style="width: 100%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80%; height: 18px; margin-top: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 60%; height: 18px; margin-top: 8px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Contenedor para captura de pantalla/PDF -->
  <div id="printable-content" *ngIf="!cargando">
  <!-- Header con info del cliente (solo se muestra una vez) -->
  <div class="client-header" *ngIf="historiales.length > 0">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person-circle" color="primary"></ion-icon>
          {{clienteNombre}}
        </ion-card-title>
        <ion-card-subtitle>
          <ion-icon name="cube" color="medium"></ion-icon>
          {{productoNombre}}
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="contact-info">
          <ion-icon name="call" color="success"></ion-icon>
          <span>{{telefonoDisplay}}</span>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Timeline de transacciones -->
  <div class="timeline-container">
    <ion-card *ngFor="let historial of historiales; let i = index" class="transaction-card">
      <div class="transaction-icon" [ngClass]="{'first-transaction': i === 0}">
        <ion-icon [name]="historial.diferencia > 0 ? 'arrow-up-circle' : 'arrow-down-circle'"
                  [color]="historial.diferencia > 0 ? 'danger' : 'success'"></ion-icon>
      </div>

      <ion-card-content>
        <div class="transaction-header">
          <span class="transaction-date">
            <ion-icon name="calendar" color="medium"></ion-icon>
            {{historial.fechas}}
          </span>
          <span class="payment-method">
            <ion-badge color="medium">{{historial.tipopago}}</ion-badge>
          </span>
        </div>

        <div class="transaction-details">
          <div class="detail-row" *ngIf="i === 0">
            <span class="label">Monto inicial:</span>
            <span class="value initial">Gs. {{moneda(historial.montos)}}</span>
          </div>

          <div class="detail-row" *ngIf="i !== 0 && historial.diferencia < 0">
            <span class="label">Pago realizado:</span>
            <span class="value payment">Gs. {{moneda(historial.pagoAnterior)}}</span>
          </div>

          <div class="detail-row" *ngIf="i !== 0 && historial.diferencia > 0">
            <span class="label">Mercadería agregada:</span>
            <span class="value merchandise">Gs. {{moneda(historial.pagoAnterior)}}</span>
          </div>

          <div class="detail-row total-row">
            <span class="label">Saldo:</span>
            <span class="value total">Gs. {{moneda(historial.montos)}}</span>
          </div>

          <div class="detail-notes" *ngIf="historial.detalles && historial.diferencia > 0 && i !== 0">
            <ion-icon name="document-text" color="medium"></ion-icon>
            <span>{{historial.detalles}}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Badge de estado -->
  <div class="status-badge" *ngIf="!deudaCancelada">
    <ion-chip color="warning">
      <ion-icon name="time"></ion-icon>
      <ion-label>Deuda Activa - Gs. {{moneda(montoActual)}}</ion-label>
    </ion-chip>
  </div>
  <div class="status-badge" *ngIf="deudaCancelada">
    <ion-chip color="success">
      <ion-icon name="checkmark-circle"></ion-icon>
      <ion-label>Deuda Cancelada</ion-label>
    </ion-chip>
  </div>
  </div><!-- Fin printable-content -->

  <!-- Mensaje si no hay datos -->
  <div class="empty-state" *ngIf="!cargando && historiales.length === 0">
    <ion-icon name="receipt-outline" color="medium"></ion-icon>
    <h3>No se encontró información</h3>
    <p>No se pudo cargar el historial de esta deuda</p>
    <ion-button routerLink="/deudas-clientes" color="primary">
      <ion-icon slot="start" name="arrow-back"></ion-icon>
      Volver a Deudas
    </ion-button>
  </div>

  <!-- Botones de acción principales -->
  <div class="action-buttons" *ngIf="!cargando && historiales.length > 0">
    <ion-button expand="block" [href]="whatsappUrl" color="success" [disabled]="!whatsappUrl">
      <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
      WhatsApp
    </ion-button>
    <ion-button expand="block" (click)="tomarScreen()" color="primary">
      <ion-icon slot="start" name="image"></ion-icon>
      Capturar Boleta
    </ion-button>
    <ion-button expand="block" (click)="generatePdf()" color="secondary">
      <ion-icon slot="start" name="document"></ion-icon>
      Generar PDF
    </ion-button>
  </div>

  <!-- Formulario de acciones (solo si hay deuda activa) -->
  <div class="actions-form" *ngIf="!cargando && !deudaCancelada && historiales.length > 0">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Gestionar Deuda</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="floating">Monto</ion-label>
          <ion-input type="number" [(ngModel)]="montoDeuda" placeholder="Ingrese el monto"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Detalle</ion-label>
          <ion-input [(ngModel)]="detalle" placeholder="Ingrese el detalle"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label>Método de Pago</ion-label>
          <ionic-selectable
            [(ngModel)]="seleccionarMet"
            [items]="metodoPago"
            itemValueField="id"
            itemTextField="name"
            [canSearch]="true"
            (onChange)="portChangeM($event)">
          </ionic-selectable>
        </ion-item>

        <ion-grid class="action-buttons-grid">
          <ion-row>
            <ion-col size="6">
              <ion-button expand="block" color="success"
                (click)="confirmarPagoDeuda(historiales[historiales.length - 1], 1)"
                [routerLink]="['/deudas-clientes']">
                <ion-icon slot="start" name="cash"></ion-icon>
                Pagar
              </ion-button>
            </ion-col>
            <ion-col size="6">
              <ion-button expand="block" color="warning"
                (click)="confirmarPagoDeuda(historiales[historiales.length - 1], 2)"
                [routerLink]="['/deudas-clientes']">
                <ion-icon slot="start" name="add-circle"></ion-icon>
                Aumentar
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
